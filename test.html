<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>test</title>
<script src="raphael-min.js"></script>
<script>
Raphael.fn.newIdea = function(parent){
	var dragger = function () {
		this.ox = this.type == "rect" ? this.attr("x") : this.attr("cx");
		this.oy = this.type == "rect" ? this.attr("y") : this.attr("cy");
		this.mainBody.ox = this.type == "rect" ? this.mainBody.attr("x") : this.mainBody.attr("cx");
		this.mainBody.oy = this.type == "rect" ? this.mainBody.attr("y") : this.mainBody.attr("cy");

		this.animate({"fill-opacity": .5}, 100);
	},
	move = function (dx, dy) {
		var att = this.type == "rect" ? {x: this.ox + dx, y: this.oy + dy} : {cx: this.ox + dx, cy: this.oy + dy};
		this.attr(att);
		att = this.type == "rect" ? {x: this.mainBody.ox + dx, y: this.mainBody.oy + dy} : {cx: this.mainBody.ox + dx, cy: this.mainBody.oy + dy};
		this.mainBody.attr(att);
		
		//if there is a parent in this idea, move a line to a parent
		if(this.parentLine){
		  var line = this.parentLine;
		  
		  var bbIdea = this.anIdea.getBBox();
		  var centerIdea = {x:bbIdea.x+bbIdea.width/2, y:bbIdea.y+bbIdea.height/2};
		  var linePath = line.attr("path").toString().split(/[L,]/);
		  linePath[2] = centerIdea.x;
		  linePath[3] = centerIdea.y;
		  var newLinePath = [linePath[0],linePath[1],'L',linePath[2],linePath[3]].join(',');
		  line.attr({path:newLinePath}).toBack();
		}
		
		//if there are some children in this idea, move lines to children
		if(this.anIdea.childrenLines){
		  for(i=0; i<this.anIdea.childrenLines.length; ++i){
			  var line = this.anIdea.childrenLines[i];
			  
			  var bbIdea = this.anIdea.getBBox();
			  var centerIdea = {x:bbIdea.x+bbIdea.width/2, y:bbIdea.y+bbIdea.height/2};
			  var linePath = line.attr("path").toString().split(/[ML,]/);
			  linePath[0] = 'M';
			  linePath[1] = centerIdea.x;
			  linePath[2] = centerIdea.y;
			  var newLinePath = [linePath[0],linePath[1],linePath[2],'L',linePath[3],linePath[4]].join(',');
			  line.attr({path:newLinePath}).toBack();
		  }
		}

		this.toFront();
		this.mainBody.toFront();
		
		this.paper.safari();
	},
	up = function () {
		this.animate({"fill-opacity": 1}, 100);
	};
	
	var anIdea = this.set();
	
	var startPoint = {x:40, y:40};
	//if there is a parent in this idea, add some offset to position
	if(parent){
	  var bbParent = parent.getBBox();
	  startPoint.x += bbParent.x + bbParent.width + 10;
	}
		
	var ideaBar = this.rect(startPoint.x,startPoint.y,200,20,0)
	  .attr({"fill":"#c00", "stroke":"#000", "stroke-width":3})
	  .drag(move,dragger,up);
	var ideaMain = this.rect(startPoint.x,startPoint.y+20,200,50,0)
	  .attr({"fill":"#fff", "stroke":"#000", "stroke-width":3});
	var addIdea = this.rect(startPoint.x+180, startPoint.y, 20, 20, 0)
	  .attr({"fill":"#c88", "stroke-width":3});
	
	ideaBar.mainBody = ideaMain;
	ideaBar.addIdea = addIdea;
	anIdea.push( ideaBar, ideaMain, addIdea);
	
	//if there is a parent, add a line to a parent
	if(parent){
	  var bbIdea = anIdea.getBBox(), bbParent = parent.getBBox();
	  var centerIdea = {x:bbIdea.x+bbIdea.width/2, y:bbIdea.y+bbIdea.height/2},
	    centerParent = {x:bbParent.x+bbParent.width/2, y:bbParent.y+bbParent.height/2};
	  var path = ["M", centerParent.x, centerParent.y, "L", centerIdea.x, centerIdea.y].join(',');
	  var line = this.path(path)
	    .attr({stroke: "#000", fill: "none", "stroke-width": 3})
	    .toBack();
	  
	  if(!parent.childrenLines){
	    parent.childrenLines = [];
	  }
	  parent.childrenLines.push(line);
	  ideaBar.parentLine = line;
	}
	
	ideaBar.anIdea = anIdea;
	
	return anIdea;
};

window.onload = function(){
	var paper = Raphael(0, 0, 1000, 600);
	
	var firstE = paper.newIdea();
	var secondE = paper.newIdea(firstE);
	paper.newIdea(firstE);
	paper.newIdea(secondE);
};
</script>
</head>
<body>
<div id="canvas">
</div>
</body>
</html>