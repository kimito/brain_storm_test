<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>test</title>
<script src="raphael-min.js"></script>
<script>
Raphael.fn.newIdea = function(parent){
	var dragger = function () {
		this.ox = this.type == "rect" ? this.attr("x") : this.attr("cx");
		this.oy = this.type == "rect" ? this.attr("y") : this.attr("cy");
		this.mainBody.ox = this.type == "rect" ? this.mainBody.attr("x") : this.mainBody.attr("cx");
		this.mainBody.oy = this.type == "rect" ? this.mainBody.attr("y") : this.mainBody.attr("cy");

		this.animate({"fill-opacity": 1}, 100);
	},
	move = function (dx, dy) {
		var att = this.type == "rect" ? {x: this.ox + dx, y: this.oy + dy} : {cx: this.ox + dx, cy: this.oy + dy};
		this.attr(att);
		att = this.type == "rect" ? {x: this.mainBody.ox + dx, y: this.mainBody.oy + dy} : {cx: this.mainBody.ox + dx, cy: this.mainBody.oy + dy};
		this.mainBody.attr(att);
		
		if(this.parent){
		  var bbIdea = this.anIdea.getBBox(), bbParent = this.parent.getBBox();
		  var centerIdea = {x:bbIdea.x+bbIdea.width/2, y:bbIdea.y+bbIdea.height/2},
		  centerParent = {x:bbParent.x+bbParent.width/2, y:bbParent.y+bbParent.height/2};
		  var linePath = ["M", centerParent.x, centerParent.y, "L", centerIdea.x, centerIdea.y].join(',');
		  this.parentLine.attr({path:linePath});
		}

		this.toFront();
		this.mainBody.toFront();
		
		this.paper.safari();
	},
	up = function () {
		this.animate({"fill-opacity": .2}, 100);
	};
	
	var anIdea = this.set();
	
	var startPoint = {x:40, y:40};
	if(parent){
	  var bbParent = parent.getBBox();
	  startPoint.x += bbParent.x + bbParent.width + 10;
	}
		
	var ideaBar = this.rect(startPoint.x,startPoint.y,200,20,0).attr("fill-opacity",.2).attr("fill", "#f00").attr("stroke", "#000").attr("stroke-width", 3).drag(move,dragger,up);
	var ideaMain = this.rect(startPoint.x,startPoint.y+20,200,100,0).attr("fill", "#fff").attr("stroke", "#000").attr("stroke-width", 3);
	ideaBar.mainBody = ideaMain;

	anIdea.push( ideaBar, ideaMain );
	
	if(parent){
	  var bbIdea = anIdea.getBBox(), bbParent = parent.getBBox();
	  var centerIdea = {x:bbIdea.x+bbIdea.width/2, y:bbIdea.y+bbIdea.height/2},
	    centerParent = {x:bbParent.x+bbParent.width/2, y:bbParent.y+bbParent.height/2};
	  var path = ["M", centerParent.x, centerParent.y, "L", centerIdea.x, centerIdea.y].join(',');
	  var line = this.path(path).attr({stroke: "#000", fill: "none", "stroke-width": 3}).toBack();
	  
	  parent.childrenLine = line;
	  ideaBar.parentLine = line;
	  ideaBar.parent = parent;
	}
	
	ideaBar.anIdea = anIdea;
	
	return anIdea;
};

window.onload = function(){
	var paper = Raphael(10, 50, 800, 400);
	
	var firstE = paper.newIdea();
	paper.newIdea(firstE);
};
</script>
</head>
<body>
<div id="canvas">
</div>
</body>
</html>